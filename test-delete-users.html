<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Suppression Utilisateurs - GLP1 France</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .env-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .users-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .user-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-item:hover {
            background: #e9ecef;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ª Test Suppression Utilisateurs</h1>
        <p>Interface de test pour validation des APIs de suppression - Compatible Local/Hostinger</p>
    </div>
    
    <!-- Informations d'environnement -->
    <div class="env-info">
        <strong>ğŸŒ Environnement dÃ©tectÃ©:</strong> <span id="env-detected">-</span><br>
        <strong>ğŸ”— API utilisÃ©e:</strong> <span id="api-endpoint">-</span><br>
        <strong>ğŸŒ Hostname:</strong> <span id="hostname">-</span><br>
        <strong>ğŸ“ URL complÃ¨te:</strong> <span id="full-url">-</span>
    </div>
    
    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-users">-</div>
            <div>Utilisateurs Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="api-tests">0</div>
            <div>Tests EffectuÃ©s</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="success-rate">-</div>
            <div>Taux de SuccÃ¨s</div>
        </div>
    </div>
    
    <!-- Section 1: Test de connexion API -->
    <div class="test-section">
        <h3>ğŸ“¡ Test de Connexion API</h3>
        <button class="btn btn-primary" onclick="testApiConnection()">
            Tester la Connexion
        </button>
        <button class="btn btn-success" onclick="loadUsers()">
            Charger les Utilisateurs
        </button>
        <div id="connection-result" class="result" style="display: none;"></div>
    </div>
    
    <!-- Section 2: Liste des utilisateurs -->
    <div class="test-section">
        <h3>ğŸ‘¥ Utilisateurs Disponibles</h3>
        <div id="users-container">
            <p>Cliquez sur "Charger les Utilisateurs" pour afficher la liste</p>
        </div>
    </div>
    
    <!-- Section 3: Test de suppression -->
    <div class="test-section">
        <h3>ğŸ—‘ï¸ Test de Suppression</h3>
        <div class="form-group">
            <label for="email-to-delete">Email Ã  supprimer:</label>
            <input type="email" id="email-to-delete" placeholder="test@example.com">
        </div>
        <div class="form-group">
            <label for="delete-mode">Mode de suppression:</label>
            <select id="delete-mode">
                <option value="safe">ğŸ›¡ï¸ Mode SÃ©curisÃ© (avec backup)</option>
                <option value="direct">âš¡ Mode Direct</option>
                <option value="simulation">ğŸ§ª Simulation (sans suppression rÃ©elle)</option>
            </select>
        </div>
        <button class="btn btn-danger" onclick="testDeleteUser()">
            ğŸ—‘ï¸ Tester la Suppression
        </button>
        <button class="btn btn-primary" onclick="createTestUser()">
            â• CrÃ©er Utilisateur Test
        </button>
        <div id="delete-result" class="result" style="display: none;"></div>
    </div>
    
    <!-- Section 4: Validation des backups -->
    <div class="test-section">
        <h3>ğŸ’¾ Validation des Backups</h3>
        <button class="btn btn-primary" onclick="validateBackups()">
            ğŸ” VÃ©rifier les Backups
        </button>
        <button class="btn btn-success" onclick="listBackups()">
            ğŸ“‹ Lister les Backups
        </button>
        <div id="backup-result" class="result" style="display: none;"></div>
    </div>
    
    <!-- Section 5: Logs et diagnostic -->
    <div class="test-section">
        <h3>ğŸ“Š Logs et Diagnostic</h3>
        <button class="btn btn-primary" onclick="checkLogs()">
            ğŸ“‹ VÃ©rifier les Logs
        </button>
        <button class="btn btn-success" onclick="diagnoseEnvironment()">
            ğŸ”§ Diagnostic Complet
        </button>
        <button class="btn btn-danger" onclick="clearTestData()">
            ğŸ§¹ Nettoyer les DonnÃ©es Test
        </button>
        <div id="diagnostic-result" class="result" style="display: none;"></div>
    </div>

    <script>
        // Configuration et variables globales
        let users = [];
        let testsPerformed = 0;
        let successfulTests = 0;
        
        // DÃ©tection de l'environnement
        function detectEnvironment() {
            const hostname = window.location.hostname;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return {
                    env: 'local',
                    deleteApi: '/api/delete-user.php',
                    usersApi: '/api/user-management.ts'
                };
            } else {
                return {
                    env: 'production',
                    deleteApi: '/api/delete-user-hostinger.php',
                    usersApi: '/api/user-management.ts'
                };
            }
        }
        
        // Initialisation
        function init() {
            const config = detectEnvironment();
            
            document.getElementById('env-detected').textContent = config.env.toUpperCase();
            document.getElementById('api-endpoint').textContent = config.deleteApi;
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('full-url').textContent = window.location.href;
        }
        
        // Afficher un rÃ©sultat
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // IncrÃ©menter les compteurs
        function updateStats(success = false) {
            testsPerformed++;
            if (success) successfulTests++;
            
            document.getElementById('api-tests').textContent = testsPerformed;
            document.getElementById('success-rate').textContent = 
                testsPerformed > 0 ? Math.round((successfulTests / testsPerformed) * 100) + '%' : '-';
        }
        
        // Test de connexion API
        async function testApiConnection() {
            const config = detectEnvironment();
            
            try {
                showResult('connection-result', 'ğŸ”„ Test de connexion en cours...', 'info');
                
                const response = await fetch(config.usersApi + '?action=list&test=1', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const result = `âœ… CONNEXION RÃ‰USSIE\n\n` +
                                 `ğŸ“Š Statut: ${response.status} ${response.statusText}\n` +
                                 `ğŸ”— Endpoint: ${config.usersApi}\n` +
                                 `ğŸ‘¥ Utilisateurs: ${data.users ? data.users.length : 0}\n` +
                                 `ğŸŒ Environnement: ${config.env}\n` +
                                 `â° Timestamp: ${new Date().toLocaleString()}`;
                    
                    showResult('connection-result', result, 'success');
                    updateStats(true);
                } else {
                    throw new Error(`API Error: ${data.error || 'Unknown error'}`);
                }
                
            } catch (error) {
                const result = `âŒ Ã‰CHEC DE CONNEXION\n\n` +
                             `ğŸš¨ Erreur: ${error.message}\n` +
                             `ğŸ”— Endpoint testÃ©: ${config.usersApi}\n` +
                             `ğŸŒ Environnement: ${config.env}\n` +
                             `â° Timestamp: ${new Date().toLocaleString()}`;
                
                showResult('connection-result', result, 'error');
                updateStats(false);
            }
        }
        
        // Charger les utilisateurs
        async function loadUsers() {
            const config = detectEnvironment();
            
            try {
                const response = await fetch(config.usersApi + '?action=list', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    users = data.users || [];
                    document.getElementById('total-users').textContent = users.length;
                    
                    displayUsers();
                    
                    const result = `âœ… ${users.length} utilisateurs chargÃ©s avec succÃ¨s`;
                    showResult('connection-result', result, 'success');
                } else {
                    throw new Error(data.error || 'Erreur de chargement');
                }
                
            } catch (error) {
                showResult('connection-result', `âŒ Erreur: ${error.message}`, 'error');
            }
        }
        
        // Afficher les utilisateurs
        function displayUsers() {
            const container = document.getElementById('users-container');
            
            if (users.length === 0) {
                container.innerHTML = '<p>ğŸ“­ Aucun utilisateur trouvÃ©</p>';
                return;
            }
            
            const usersList = users.map(user => `
                <div class="user-item">
                    <div>
                        <strong>${user.email}</strong>
                        ${user.name ? `<br><small>${user.name}</small>` : ''}
                    </div>
                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                            onclick="quickDelete('${user.email}')">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="users-list">
                    ${usersList}
                </div>
            `;
        }
        
        // Suppression rapide depuis la liste
        function quickDelete(email) {
            document.getElementById('email-to-delete').value = email;
            testDeleteUser();
        }
        
        // Test de suppression
        async function testDeleteUser() {
            const email = document.getElementById('email-to-delete').value.trim();
            const mode = document.getElementById('delete-mode').value;
            
            if (!email) {
                showResult('delete-result', 'âŒ Veuillez saisir un email', 'error');
                return;
            }
            
            if (mode === 'simulation') {
                const result = `ğŸ§ª SIMULATION DE SUPPRESSION\n\n` +
                             `ğŸ“§ Email: ${email}\n` +
                             `ğŸ›¡ï¸ Mode: ${mode}\n` +
                             `âœ… Validation: Email format OK\n` +
                             `â° Timestamp: ${new Date().toLocaleString()}\n\n` +
                             `âš ï¸ Aucune suppression rÃ©elle effectuÃ©e`;
                
                showResult('delete-result', result, 'info');
                updateStats(true);
                return;
            }
            
            const config = detectEnvironment();
            
            try {
                showResult('delete-result', `ğŸ”„ Suppression de ${email} en cours...`, 'info');
                
                const response = await fetch(config.deleteApi, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const successMsg = `âœ… SUPPRESSION RÃ‰USSIE\n\n` +
                                     `ğŸ“§ Email supprimÃ©: ${email}\n` +
                                     `ğŸ‘¤ Nom: ${result.data?.userName || 'N/A'}\n` +
                                     `ğŸ“Š Utilisateurs: ${result.data?.previousCount} â†’ ${result.data?.newCount}\n` +
                                     `ğŸ’¾ Backup: ${result.data?.backupFile || 'CrÃ©Ã©'}\n` +
                                     `ğŸŒ Environnement: ${result.data?.environment || config.env}\n` +
                                     `â° Timestamp: ${result.data?.timestamp || new Date().toLocaleString()}`;
                    
                    showResult('delete-result', successMsg, 'success');
                    updateStats(true);
                    
                    // Recharger la liste
                    loadUsers();
                    
                } else {
                    throw new Error(result.error || 'Erreur inconnue');
                }
                
            } catch (error) {
                const errorMsg = `âŒ Ã‰CHEC DE SUPPRESSION\n\n` +
                               `ğŸ“§ Email: ${email}\n` +
                               `ğŸš¨ Erreur: ${error.message}\n` +
                               `ğŸ”— API: ${config.deleteApi}\n` +
                               `ğŸŒ Environnement: ${config.env}\n` +
                               `â° Timestamp: ${new Date().toLocaleString()}`;
                
                showResult('delete-result', errorMsg, 'error');
                updateStats(false);
            }
        }
        
        // CrÃ©er un utilisateur de test
        async function createTestUser() {
            const testEmail = `test-${Date.now()}@glp1test.com`;
            const testName = `Utilisateur Test ${new Date().toLocaleString()}`;
            
            try {
                const config = detectEnvironment();
                
                const response = await fetch(config.usersApi, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: testEmail,
                        name: testName,
                        source: 'test-interface',
                        type: 'test_user'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    document.getElementById('email-to-delete').value = testEmail;
                    
                    const successMsg = `âœ… UTILISATEUR TEST CRÃ‰Ã‰\n\n` +
                                     `ğŸ“§ Email: ${testEmail}\n` +
                                     `ğŸ‘¤ Nom: ${testName}\n` +
                                     `ğŸ”— ID: ${result.user?.id || 'N/A'}\n` +
                                     `â° CrÃ©Ã©: ${new Date().toLocaleString()}`;
                    
                    showResult('delete-result', successMsg, 'success');
                    loadUsers();
                    
                } else {
                    throw new Error(result.error || 'Erreur de crÃ©ation');
                }
                
            } catch (error) {
                showResult('delete-result', `âŒ Erreur crÃ©ation: ${error.message}`, 'error');
            }
        }
        
        // Valider les backups
        function validateBackups() {
            const result = `ğŸ” VALIDATION DES BACKUPS\n\n` +
                         `ğŸ“Š FonctionnalitÃ©: En cours d'implÃ©mentation\n` +
                         `ğŸ¯ Objectif: VÃ©rifier l'intÃ©gritÃ© des backups\n` +
                         `ğŸ“ Localisation: data/backups/\n` +
                         `â° Timestamp: ${new Date().toLocaleString()}\n\n` +
                         `ğŸ’¡ Cette fonctionnalitÃ© sera dÃ©veloppÃ©e prochainement`;
            
            showResult('backup-result', result, 'info');
        }
        
        // Lister les backups
        function listBackups() {
            const result = `ğŸ“‹ LISTE DES BACKUPS\n\n` +
                         `ğŸ“Š FonctionnalitÃ©: En cours d'implÃ©mentation\n` +
                         `ğŸ¯ Objectif: Afficher tous les fichiers de backup\n` +
                         `ğŸ“ Localisation: data/backups/\n` +
                         `â° Timestamp: ${new Date().toLocaleString()}\n\n` +
                         `ğŸ’¡ Cette fonctionnalitÃ© sera dÃ©veloppÃ©e prochainement`;
            
            showResult('backup-result', result, 'info');
        }
        
        // VÃ©rifier les logs
        function checkLogs() {
            const result = `ğŸ“‹ VÃ‰RIFICATION DES LOGS\n\n` +
                         `ğŸ“Š FonctionnalitÃ©: En cours d'implÃ©mentation\n` +
                         `ğŸ¯ Objectif: Afficher les derniÃ¨res entrÃ©es de logs\n` +
                         `ğŸ“ Localisation: logs/user-deletions.log\n` +
                         `â° Timestamp: ${new Date().toLocaleString()}\n\n` +
                         `ğŸ’¡ Cette fonctionnalitÃ© sera dÃ©veloppÃ©e prochainement`;
            
            showResult('diagnostic-result', result, 'info');
        }
        
        // Diagnostic complet
        function diagnoseEnvironment() {
            const config = detectEnvironment();
            
            const result = `ğŸ”§ DIAGNOSTIC COMPLET\n\n` +
                         `ğŸŒ Environnement: ${config.env}\n` +
                         `ğŸŒ Hostname: ${window.location.hostname}\n` +
                         `ğŸ“ URL: ${window.location.href}\n` +
                         `ğŸ”— API Suppression: ${config.deleteApi}\n` +
                         `ğŸ”— API Utilisateurs: ${config.usersApi}\n` +
                         `ğŸ‘¥ Utilisateurs chargÃ©s: ${users.length}\n` +
                         `ğŸ§ª Tests effectuÃ©s: ${testsPerformed}\n` +
                         `âœ… Taux de succÃ¨s: ${testsPerformed > 0 ? Math.round((successfulTests / testsPerformed) * 100) + '%' : '0%'}\n` +
                         `ğŸ•’ User Agent: ${navigator.userAgent.substring(0, 100)}...\n` +
                         `â° Timestamp: ${new Date().toLocaleString()}`;
            
            showResult('diagnostic-result', result, 'info');
        }
        
        // Nettoyer les donnÃ©es de test
        function clearTestData() {
            if (!confirm('âš ï¸ Supprimer tous les utilisateurs de test ?\n\nCela supprimera tous les utilisateurs avec un email contenant "test".')) {
                return;
            }
            
            const testUsers = users.filter(user => user.email.includes('test'));
            
            if (testUsers.length === 0) {
                showResult('diagnostic-result', 'âœ… Aucun utilisateur de test trouvÃ©', 'info');
                return;
            }
            
            const result = `ğŸ§¹ NETTOYAGE DES DONNÃ‰ES TEST\n\n` +
                         `ğŸ“Š Utilisateurs test trouvÃ©s: ${testUsers.length}\n` +
                         `ğŸ“§ Emails: ${testUsers.map(u => u.email).join(', ')}\n` +
                         `â° Timestamp: ${new Date().toLocaleString()}\n\n` +
                         `ğŸ’¡ Utilisez la suppression individuelle pour confirmer`;
            
            showResult('diagnostic-result', result, 'info');
        }
        
        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>
