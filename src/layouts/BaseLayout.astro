---
import '../styles/global.css';
import GoogleAnalytics from '../components/GoogleAnalytics.astro';
import AffiliateProduct from '../components/AffiliateProduct.astro';
import { getProductsByBrand } from '../utils/affiliate-manager.ts';

export interface Props {
  title: string;
  description: string;
  keywords?: string;
}

const { title, description, keywords = "" } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Produits affili√©s pour le footer - approche simplifi√©e
const footerProducts = getProductsByBrand('Talika', 1);
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="canonical" href={canonicalURL}>
  
  <!-- SEO Meta Tags -->
  <title>{title}</title>
  <meta name="description" content={description}>
  {keywords && <meta name="keywords" content={keywords}>}
  
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content={canonicalURL}>
  <meta property="og:title" content={title}>
  <meta property="og:description" content={description}>
  <meta property="og:image" content="/og-image.jpg">
  
  <!-- Twitter Card -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content={canonicalURL}>
  <meta property="twitter:title" content={title}>
  <meta property="twitter:description" content={description}>
  <meta property="twitter:image" content="/og-image.jpg">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Google Analytics -->
  <GoogleAnalytics />
  
</head>
<body>
  <header class="header">
    <nav class="nav container">
      <div class="nav-brand">
        <a href="/" class="brand-link" aria-label="Accueil GLP-1 France" style="display:flex;align-items:center;gap:0.75rem;">
          <span class="brand-logo" style="display:inline-block;vertical-align:middle;">
            <svg viewBox="0 0 64 64" width="48" height="48" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" aria-label="Health icon: drop, leaf and sparkle">
              <!-- Fond rond pour contraste -->
              <circle cx="32" cy="32" r="30" fill="#ffffff" stroke="#e5e7eb" stroke-width="2"/>
              <!-- Goutte (bleu plus vif) -->
              <path d="M32 10c8 12 18 18 18 28a18 18 0 1 1-36 0c0-10 10-16 18-28Z" fill="#1d4ed8" stroke="#1e40af" stroke-width="2"/>
              <!-- Feuille (vert plus vif) -->
              <path d="M42 28c-8 0-14 6-14 14 0 6 4 10 10 10 8 0 12-6 12-12 0-6-4-12-8-12Z" fill="#16a34a" stroke="#15803d" stroke-width="2"/>
              <path d="M36 44c2-6 6-10 10-12" stroke="#15803d" fill="none" stroke-width="2"/>
              <!-- √âtincelle (jaune dor√© plus visible) -->
              <path d="M49 16l2 4 4 2-4 2-2 4-2-4-4-2 4-2 2-4Z" fill="#f59e0b" stroke="#d97706" stroke-width="1"/>
            </svg>
          </span>
          <span class="brand-text" style="font-size:1.5rem;font-weight:600;color:#111;">GLP-1 France</span>
        </a>
      </div>

      <!-- Barre de recherche -->
      <div class="search-container">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Rechercher un article..." 
            id="search-input"
            class="search-input"
            autocomplete="off"
          >
          <div class="search-icon">üîç</div>
          <div id="search-results" class="search-results hidden"></div>
          <div id="search-suggestions" class="search-suggestions hidden"></div>
        </div>
      </div>
      
      <div class="nav-menu" id="nav-menu">
        <ul class="nav-list">
          <li class="nav-item">
            <a href="/quel-traitement-glp1-choisir/" class="nav-link diagnostic-highlight">üéØ Diagnostic</a>
          </li>
          <li class="nav-item">
            <a href="/nouveaux-medicaments-perdre-poids/" class="nav-link">Perdre du Poids</a>
          </li>
          <li class="nav-item">
            <a href="/glp1-cout/" class="nav-link">Prix</a>
          </li>
          <li class="nav-item">
            <a href="/medicaments-glp1/" class="nav-link">M√©dicaments</a>
          </li>
          <li class="nav-item">
            <a href="/effets-secondaires-glp1/" class="nav-link">Effets</a>
          </li>
          <li class="nav-item">
            <a href="/avant-apres-glp1/" class="nav-link">T√©moignages</a>
          </li>
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle">Plus ‚ñº</a>
            <ul class="dropdown-menu">
              <li><a href="/qu-est-ce-que-glp1/" class="dropdown-link">Qu'est-ce que GLP-1 ?</a></li>
              <li><a href="/experts/" class="dropdown-link">Nos Experts</a></li>
              <li><a href="/guide-beaute-perte-de-poids-glp1/" class="dropdown-link">Guide Gratuit</a></li>
              <li><a href="/glp1-diabete/" class="dropdown-link">Diab√®te</a></li>
              <li><a href="/regime-glp1/" class="dropdown-link">R√©gime</a></li>
              <li><a href="/alternatives-glp1/" class="dropdown-link">Alternatives</a></li>
              <li><a href="/medecins-glp1-france/" class="dropdown-link">M√©decins</a></li>
              <li><a href="/recherche-glp1/" class="dropdown-link">Recherche</a></li>
            </ul>
          </li>
        </ul>
      </div>
      
      <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
        <span class="hamburger"></span>
      </button>
    </nav>
  </header>
  
  <main class="main">
    <slot />
  </main>
  
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3 class="footer-title">GLP-1 France</h3>
          <p class="footer-text">
            Votre guide complet sur les traitements GLP-1 en France. 
            Informations m√©dicales, conseils et actualit√©s.
          </p>
        </div>
        
        <div class="footer-section">
          <h4 class="footer-subtitle">Categories</h4>
          <ul class="footer-links">
            <li><a href="/glp1-cout/">Prix & Achat</a></li>
            <li><a href="/medicaments-glp1/">M√©dicaments</a></li>
            <li><a href="/glp1-perte-de-poids/">Perte de Poids</a></li>
            <li><a href="/effets-secondaires-glp1/">Effets Secondaires</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4 class="footer-subtitle">Ressources</h4>
          <ul class="footer-links">
            <li><a href="/glp1-diabete/">GLP-1 et Diab√®te</a></li>
            <li><a href="/regime-glp1/">R√©gime Alimentaire</a></li>
            <li><a href="/alternatives-glp1/">Alternatives</a></li>
            <li><a href="/medecins-glp1-france/">M√©decins</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h4 class="footer-subtitle">Produits Recommand√©s</h4>
          {footerProducts[0] && (
            <AffiliateProduct 
              productId={footerProducts[0].id}
              placement="footer"
              variant="compact"
              className="footer-affiliate"
              showIfRelevant={false}
            />
          )}
        </div>
        
        <div class="footer-section">
          <h4 class="footer-subtitle">Newsletter</h4>
          <p class="footer-text">Recevez nos derniers conseils et actualit√©s GLP-1</p>
          <form class="newsletter-form" id="newsletterForm">
            <input 
              type="email" 
              name="email" 
              id="newsletterEmail"
              placeholder="Votre email" 
              class="newsletter-input" 
              required
            >
            <button type="submit" class="newsletter-btn">S'abonner</button>
          </form>
          <div class="newsletter-message hidden" id="newsletter-message">
            <p class="message-text">‚úÖ Merci ! Votre email a √©t√© enregistr√©.</p>
          </div>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p class="footer-copyright">
          ¬© 2025 GLP-1 France. Tous droits r√©serv√©s. | 
          <a href="/mentions-legales/">Mentions l√©gales</a> | 
          <a href="/politique-confidentialite/">Politique de confidentialit√©</a> | 
          <a href="/contact/">Contactez-nous</a>
        </p>
      </div>
    </div>
  </footer>
  
  <script>
    // Mobile menu toggle
    const navToggle = document.getElementById('nav-toggle');
    const navMenu = document.getElementById('nav-menu');
    
    navToggle?.addEventListener('click', () => {
      navMenu?.classList.toggle('active');
      navToggle.classList.toggle('active');
    });
    
    // Close mobile menu when clicking on a link
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        navMenu?.classList.remove('active');
        navToggle?.classList.remove('active');
      });
    });

    // Newsletter form handler
    const newsletterForm = document.querySelector('.newsletter-form');
    const newsletterMessage = document.getElementById('newsletter-message');
    
    if (newsletterForm) {
      newsletterForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('üöÄ Newsletter form submitted');
        
        // Masquer le message pr√©c√©dent
        newsletterMessage?.classList.add('hidden');
        
        const submitBtn = this.querySelector('.newsletter-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '‚è≥';
        submitBtn.disabled = true;
        
        try {
          const formData = new FormData(this);
          const email = formData.get('email');
          console.log('üìß Email √† envoyer:', email);
          
          console.log('üì§ Envoi vers /api/newsletter...');
          const response = await fetch('/api/newsletter', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: email,
              source: 'footer-newsletter'
            })
          });
          
          console.log('üì• R√©ponse re√ßue - Status:', response.status);
          
          if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Succ√®s:', result);
          } else {
            const error = await response.text();
            console.log('‚ùå Erreur:', error);
          }
          
          // Toujours afficher merci, m√™me en cas d'erreur API
          newsletterMessage?.classList.remove('hidden');
          this.reset();
          
          // Analytics simple
          if (typeof gtag !== 'undefined') {
            gtag('event', 'newsletter_signup', {
              'event_category': 'conversion',
              'event_label': 'footer_newsletter'
            });
          }
          
        } catch (error) {
          console.error('‚ùå Erreur newsletter:', error);
          // Toujours dire merci √† l'utilisateur
          newsletterMessage?.classList.remove('hidden');
          this.reset();
        } finally {
          console.log('üîÑ Remise en √©tat du bouton');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });
    }

    // Dropdown menu functionality
    document.querySelectorAll('.dropdown').forEach(dropdown => {
      const toggle = dropdown.querySelector('.dropdown-toggle');
      const menu = dropdown.querySelector('.dropdown-menu');
      
      toggle?.addEventListener('click', (e) => {
        e.preventDefault();
        dropdown.classList.toggle('active');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          dropdown.classList.remove('active');
        }
      });
    });

    // Base de donn√©es des articles pour la recherche - √âtendue avec plus d'articles
    const articlesData = [
      // Prix & Co√ªt
      {
        title: "Acheter Wegovy en France",
        slug: "/glp1-cout/acheter-wegovy-en-france/",
        category: "Prix & Co√ªt",
        keywords: ["wegovy", "acheter", "france", "pharmacie", "ordonnance", "prix"]
      },
      {
        title: "Wegovy Prix",
        slug: "/glp1-cout/wegovy-prix/",
        category: "Prix & Co√ªt", 
        keywords: ["wegovy", "prix", "co√ªt", "remboursement", "tarif"]
      },
      {
        title: "Saxenda Prix Pharmacie",
        slug: "/glp1-cout/saxenda-prix-pharmacie/",
        category: "Prix & Co√ªt",
        keywords: ["saxenda", "prix", "pharmacie", "co√ªt", "liraglutide"]
      },
      {
        title: "Op√©ration pour Maigrir Prix",
        slug: "/glp1-cout/operation-pour-maigrir-prix/",
        category: "Prix & Co√ªt",
        keywords: ["chirurgie", "op√©ration", "prix", "sleeve", "bypass", "co√ªt"]
      },
      {
        title: "Wegovy Remboursement Mutuelle",
        slug: "/glp1-cout/wegovy-remboursement-mutuelle/",
        category: "Prix & Co√ªt",
        keywords: ["wegovy", "remboursement", "mutuelle", "s√©cu", "prise en charge"]
      },
      {
        title: "Anneau Gastrique Prix CMU",
        slug: "/glp1-cout/anneau-gastrique-prix-cmu/",
        category: "Prix & Co√ªt",
        keywords: ["anneau", "gastrique", "cmu", "prix", "chirurgie", "bariatrique"]
      },

      // M√©dicaments
      {
        title: "M√©dicament pour Maigrir Tr√®s Puissant",
        slug: "/medicaments-glp1/medicament-pour-maigrir-tres-puissant/",
        category: "M√©dicaments",
        keywords: ["m√©dicament", "puissant", "maigrir", "efficace", "glp1"]
      },
      {
        title: "M√©dicament Am√©ricain pour Maigrir",
        slug: "/medicaments-glp1/medicament-americain-pour-maigrir/",
        category: "M√©dicaments",
        keywords: ["am√©ricain", "usa", "m√©dicament", "wegovy", "ozempic", "innovation"]
      },
      {
        title: "Mounjaro Injection pour Maigrir",
        slug: "/medicaments-glp1/mounjaro-injection-pour-maigrir/",
        category: "M√©dicaments",
        keywords: ["mounjaro", "injection", "tirzepatide", "eli lilly", "nouveau"]
      },
      {
        title: "Trulicity Danger",
        slug: "/medicaments-glp1/trulicity-danger/",
        category: "M√©dicaments",
        keywords: ["trulicity", "danger", "effets", "dulaglutide", "s√©curit√©"]
      },
      {
        title: "Dosage Trulicity",
        slug: "/medicaments-glp1/dosage-trulicity/",
        category: "M√©dicaments",
        keywords: ["trulicity", "dosage", "posologie", "dose", "prescription"]
      },
      {
        title: "Liraglutide Perte de Poids Avis",
        slug: "/medicaments-glp1/liraglutide-perte-de-poids-avis/",
        category: "M√©dicaments",
        keywords: ["liraglutide", "avis", "perte de poids", "saxenda", "t√©moignages"]
      },

      // Perte de Poids
      {
        title: "GLP-1 et Perte de Poids",
        slug: "/glp1-perte-de-poids/glp1-perte-de-poids/",
        category: "Perte de Poids",
        keywords: ["glp1", "perte", "poids", "efficacit√©", "m√©canisme"]
      },
      {
        title: "Avant Apr√®s GLP-1",
        slug: "/glp1-perte-de-poids/avant-apres-glp1/",
        category: "Perte de Poids",
        keywords: ["avant", "apr√®s", "t√©moignages", "transformation", "r√©sultats"]
      },
      {
        title: "Ozempic R√©gime",
        slug: "/glp1-perte-de-poids/ozempic-regime/",
        category: "Perte de Poids",
        keywords: ["ozempic", "r√©gime", "alimentation", "protocole", "menu"]
      },
      {
        title: "Pilule qui Fait Maigrir",
        slug: "/glp1-perte-de-poids/pilule-qui-fait-maigrir/",
        category: "Perte de Poids",
        keywords: ["pilule", "oral", "mysimba", "orlistat", "comprim√©"]
      },
      {
        title: "Chirurgie Bariatrique",
        slug: "/glp1-perte-de-poids/chirurgie-bariatrique/",
        category: "Perte de Poids",
        keywords: ["chirurgie", "bariatrique", "sleeve", "bypass", "gastroplastie"]
      },
      {
        title: "Diab√®te Amaigrissement Rapide",
        slug: "/glp1-perte-de-poids/diabete-amaigrissement-rapide/",
        category: "Perte de Poids",
        keywords: ["diab√®te", "amaigrissement", "rapide", "perte de poids", "glp1"]
      },

      // Effets Secondaires
      {
        title: "Ozempic Danger",
        slug: "/effets-secondaires-glp1/ozempic-danger/",
        category: "Effets Secondaires",
        keywords: ["ozempic", "danger", "effets", "secondaires", "risques"]
      },
      {
        title: "Wegovy Danger",
        slug: "/effets-secondaires-glp1/wegovy-danger/",
        category: "Effets Secondaires",
        keywords: ["wegovy", "danger", "s√©curit√©", "risques", "effets"]
      },
      {
        title: "Wegovy Dosage",
        slug: "/effets-secondaires-glp1/wegovy-dosage/",
        category: "Effets Secondaires",
        keywords: ["wegovy", "dosage", "posologie", "escalade", "dose"]
      },
      {
        title: "Insulevel Effet Ind√©sirable",
        slug: "/effets-secondaires-glp1/insulevel-effet-indesirable/",
        category: "Effets Secondaires",
        keywords: ["insulevel", "effet", "ind√©sirable", "secondaire", "s√©curit√©"]
      },

      // M√©decins
      {
        title: "Endocrinologue pour Maigrir",
        slug: "/medecins-glp1-france/endocrinologue-pour-maigrir/",
        category: "M√©decins",
        keywords: ["endocrinologue", "maigrir", "sp√©cialiste", "consultation", "prescription"]
      },
      {
        title: "Clinique pour Ob√©sit√©",
        slug: "/medecins-glp1-france/clinique-pour-obesite/",
        category: "M√©decins",
        keywords: ["clinique", "ob√©sit√©", "centre", "sp√©cialis√©", "traitement"]
      },

      // Alternatives
      {
        title: "Semaglutide Naturel",
        slug: "/alternatives-glp1/semaglutide-naturel/",
        category: "Alternatives",
        keywords: ["semaglutide", "naturel", "alternative", "plantes", "bio"]
      },
      {
        title: "Peut-on Gu√©rir du Diab√®te",
        slug: "/alternatives-glp1/peut-on-guerir-du-diabete/",
        category: "Alternatives",
        keywords: ["gu√©rir", "diab√®te", "r√©mission", "gu√©rison", "traitement"]
      },

      // Diab√®te
      {
        title: "Traitement Insulinique",
        slug: "/glp1-diabete/traitement-insulinique/",
        category: "Diab√®te",
        keywords: ["insuline", "traitement", "diab√®te", "injection", "protocole"]
      }
    ];

    // Mots-cl√©s populaires bas√©s sur les recherches r√©elles
    const popularKeywords = [
      "wegovy prix", "ozempic danger", "saxenda avis", "mounjaro injection",
      "m√©dicament pour maigrir", "avant apr√®s glp1", "endocrinologue sp√©cialis√©",
      "chirurgie bariatrique prix", "trulicity dosage", "ozempic r√©gime",
      "wegovy remboursement", "glp1 efficacit√©", "semaglutide naturel",
      "clinique ob√©sit√©", "pilule maigrir", "liraglutide avis"
    ];

    // Syst√®me de recherche
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const searchSuggestions = document.getElementById('search-suggestions');

    let searchTimeout;

    searchInput?.addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      
      // Clear previous timeout
      clearTimeout(searchTimeout);
      
      if (query.length === 0) {
        hideSearchResults();
        showPopularKeywords();
        return;
      }

      if (query.length === 1) {
        showAutocompleteSuggestions(query);
        return;
      }

      if (query.length < 2) {
        hideSearchResults();
        return;
      }

      // Debounce search
      searchTimeout = setTimeout(() => {
        performSearch(query);
      }, 200); // R√©duit de 300ms √† 200ms pour plus de r√©activit√©
    });

    searchInput?.addEventListener('focus', () => {
      if (searchInput.value.length === 0) {
        showPopularKeywords();
      }
    });

    searchInput?.addEventListener('blur', () => {
      // D√©lai plus long pour permettre les clics sur les suggestions
      setTimeout(() => {
        hideSearchResults();
      }, 150);
    });

    function performSearch(query) {
      // Nettoie et normalise la requ√™te
      const cleanQuery = query.trim().toLowerCase();
      if (cleanQuery.length === 0) {
        hideSearchResults();
        return;
      }

      // Recherche am√©lior√©e avec score de pertinence
      const results = articlesData.map(article => {
        let score = 0;
        
        // Score pour correspondance exacte dans le titre
        if (article.title.toLowerCase().includes(cleanQuery)) {
          score += 10;
        }
        
        // Score pour correspondance partielle dans le titre
        const titleWords = article.title.toLowerCase().split(' ');
        const queryWords = cleanQuery.split(' ');
        queryWords.forEach(queryWord => {
          titleWords.forEach(titleWord => {
            if (titleWord.includes(queryWord) && queryWord.length > 2) {
              score += 5;
            }
          });
        });
        
        // Score pour correspondance dans les mots-cl√©s
        article.keywords.forEach(keyword => {
          if (keyword.toLowerCase().includes(cleanQuery)) {
            score += 7;
          }
          queryWords.forEach(queryWord => {
            if (keyword.toLowerCase().includes(queryWord) && queryWord.length > 2) {
              score += 3;
            }
          });
        });
        
        // Score pour correspondance dans la cat√©gorie
        if (article.category.toLowerCase().includes(cleanQuery)) {
          score += 4;
        }
        
        return { ...article, score };
      })
      .filter(article => article.score > 0)
      .sort((a, b) => b.score - a.score)
      .slice(0, 8); // Augment√© √† 8 r√©sultats

      // Force l'affichage des r√©sultats m√™me s'il y en a peu
      displaySearchResults(results, cleanQuery);
    }

    function displaySearchResults(results, query) {
      selectedIndex = -1; // Reset keyboard selection
      
      if (results.length === 0) {
        searchResults.innerHTML = `
          <div class="search-result-item no-results">
            <div class="search-result-title">Aucun r√©sultat pour "${query}"</div>
            <div class="search-result-category">Essayez avec des mots-cl√©s comme "wegovy", "ozempic" ou "prix"</div>
          </div>
        `;
      } else {
        searchResults.innerHTML = `
          <div class="search-header">
            <span class="search-count">${results.length} r√©sultat${results.length > 1 ? 's' : ''} pour "${query}"</span>
          </div>
          ${results.map(article => `
            <a href="${article.slug}" class="search-result-item">
              <div class="search-result-title">${highlightQuery(article.title, query)}</div>
              <div class="search-result-category">
                <span class="category-badge">${article.category}</span>
                ${article.score > 10 ? '<span class="relevance-badge">‚úì Tr√®s pertinent</span>' : ''}
              </div>
            </a>
          `).join('')}
        `;
      }
      
      searchResults.classList.remove('hidden');
      searchSuggestions.classList.add('hidden');
    }

    function showPopularKeywords() {
      selectedIndex = -1; // Reset keyboard selection
      
      searchSuggestions.innerHTML = `
        <div class="suggestions-header">Recherches populaires :</div>
        ${popularKeywords.map(keyword => `
          <div class="suggestion-item" data-keyword="${keyword}">
            ${keyword}
          </div>
        `).join('')}
      `;
      
      searchSuggestions.classList.remove('hidden');
      searchResults.classList.add('hidden');

      // Add click handlers for suggestions with event delegation
      attachSuggestionHandlers();
    }
    
    function showAutocompleteSuggestions(query) {
      selectedIndex = -1; // Reset keyboard selection
      
      // Suggestions d'autocompl√©tion bas√©es sur les mots-cl√©s populaires et les titres d'articles
      const allTerms = [
        ...popularKeywords,
        ...articlesData.map(article => article.title.toLowerCase()),
        ...articlesData.flatMap(article => article.keywords)
      ];
      
      const suggestions = allTerms
        .filter(term => term.toLowerCase().startsWith(query.toLowerCase()))
        .slice(0, 6)
        .map(term => term.toLowerCase().replace(/^\w/, c => c.toUpperCase())); // Capitalise la premi√®re lettre
      
      if (suggestions.length > 0) {
        searchSuggestions.innerHTML = `
          <div class="suggestions-header">Suggestions :</div>
          ${suggestions.map(suggestion => `
            <div class="suggestion-item autocomplete-suggestion" data-suggestion="${suggestion}">
              <span class="suggestion-icon">üîç</span>
              ${suggestion}
            </div>
          `).join('')}
        `;
        
        searchSuggestions.classList.remove('hidden');
        searchResults.classList.add('hidden');

        // Add click handlers for autocomplete suggestions with event delegation
        attachSuggestionHandlers();
      } else {
        hideSearchResults();
      }
    }

    // Fonction pour attacher les gestionnaires d'√©v√©nements aux suggestions
    function attachSuggestionHandlers() {
      const suggestionItems = document.querySelectorAll('.suggestion-item');
      
      suggestionItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const keyword = item.dataset.keyword || item.dataset.suggestion;
          if (keyword) {
            searchInput.value = keyword;
            
            // D√©clenche la recherche imm√©diatement
            setTimeout(() => {
              performSearch(keyword.toLowerCase());
            }, 100);
          }
        });
        
        // Emp√™che la fermeture lors du mousedown
        item.addEventListener('mousedown', (e) => {
          e.preventDefault();
        });
      });
    }

    // Navigation au clavier dans les r√©sultats de recherche
    let selectedIndex = -1;
    
    searchInput?.addEventListener('keydown', (e) => {
      const visibleItems = document.querySelectorAll('.search-result-item:not(.no-results), .suggestion-item');
      
      if (visibleItems.length === 0) return;
      
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, visibleItems.length - 1);
          updateSelection(visibleItems);
          break;
          
        case 'ArrowUp':
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection(visibleItems);
          break;
          
        case 'Enter':
          e.preventDefault();
          if (selectedIndex >= 0 && visibleItems[selectedIndex]) {
            const item = visibleItems[selectedIndex];
            if (item.classList.contains('suggestion-item')) {
              const suggestion = item.dataset.suggestion || item.dataset.keyword;
              if (suggestion) {
                searchInput.value = suggestion;
                performSearch(suggestion.toLowerCase());
              }
            } else if (item.href) {
              window.location.href = item.href;
            }
          } else if (searchInput.value.trim().length > 1) {
            // Si aucun √©l√©ment n'est s√©lectionn√© mais qu'il y a du texte, lance la recherche
            performSearch(searchInput.value.trim().toLowerCase());
          }
          break;
          
        case 'Escape':
          hideSearchResults();
          searchInput.blur();
          selectedIndex = -1;
          break;
      }
    });
    
    function updateSelection(items) {
      items.forEach((item, index) => {
        item.classList.toggle('keyboard-selected', index === selectedIndex);
      });
    }

    function hideSearchResults() {
      searchResults.classList.add('hidden');
      searchSuggestions.classList.add('hidden');
      selectedIndex = -1;
    }

    function highlightQuery(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Make article cards fully clickable
    function makeArticleCardsClickable() {
      document.querySelectorAll('.article-card, .featured-article').forEach(card => {
        // Skip cards that already have a click handler
        if (card.dataset.clickableInitialized) return;
        
        // Find the main link in the card
        const mainLink = card.querySelector('.article-title a, .featured-title a');
        
        if (mainLink) {
          // Mark as initialized
          card.dataset.clickableInitialized = 'true';
          
          // Add click handler to the entire card
          card.addEventListener('click', (e) => {
            // Only handle clicks that aren't already on links or buttons
            if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON' && !e.target.closest('a, button')) {
              window.location.href = mainLink.href;
            }
          });
          
          // Add keyboard accessibility
          card.setAttribute('tabindex', '0');
          card.setAttribute('role', 'article');
          card.setAttribute('aria-label', `Lire l'article: ${mainLink.textContent}`);
          
          // Handle keyboard navigation
          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              window.location.href = mainLink.href;
            }
          });
          
          // Update cursor style
          card.style.cursor = 'pointer';
        }
      });
    }

    // Initialize clickable cards when DOM is loaded
    document.addEventListener('DOMContentLoaded', makeArticleCardsClickable);
    
    // Re-initialize after any dynamic content changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.addedNodes.length > 0) {
          makeArticleCardsClickable();
        }
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  </script>
</body>
</html>
