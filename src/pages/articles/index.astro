---
import BaseLayout from '../../layouts/BaseLayout.astro'
import ArticleCard from '../../components/ArticleCard.astro'
import { getCollection } from 'astro:content'

// Récupérer tous les articles de toutes les collections
const allArticles = await Promise.all([
  getCollection('glp1-perte-de-poids'),
  getCollection('glp1-diabete'),
  getCollection('glp1-cout'),
  getCollection('effets-secondaires-glp1'),
  getCollection('alternatives-glp1'),
  getCollection('medicaments-glp1'),
  getCollection('regime-glp1'),
  getCollection('avant-apres-glp1'),
  getCollection('recherche-glp1'),
  getCollection('medecins-glp1-france'),
]).then(collections => {
  return collections.flat().map(article => ({
    ...article,
    category: article.collection,
    url: `/${article.collection}/${article.slug}/`
  }))
}).then(articles => {
  // Algorithme de mélange avancé pour diversifier les collections
  
  // 1. Grouper par collection
  const articlesByCollection = {};
  articles.forEach(article => {
    if (!articlesByCollection[article.collection]) {
      articlesByCollection[article.collection] = [];
    }
    articlesByCollection[article.collection].push(article);
  });
  
  // 2. Trier chaque collection par titre ou date
  Object.keys(articlesByCollection).forEach(collection => {
    articlesByCollection[collection].sort((a, b) => {
      // Essayer par date d'abord, puis par titre
      const dateA = new Date(a.data.publishedAt || a.data.publishDate || a.data.datePublished || '2024-01-01');
      const dateB = new Date(b.data.publishedAt || b.data.publishDate || b.data.datePublished || '2024-01-01');
      
      if (dateA.getTime() !== dateB.getTime()) {
        return dateB - dateA; // Plus récent en premier
      }
      
      // Si même date, trier par titre
      return a.data.title.localeCompare(b.data.title);
    });
  });
  
  // 3. Algorithme de distribution équitable (round-robin)
  const mixedArticles = [];
  const collections = Object.keys(articlesByCollection);
  let maxLength = Math.max(...Object.values(articlesByCollection).map(arr => arr.length));
  
  for (let i = 0; i < maxLength; i++) {
    // Mélanger l'ordre des collections à chaque tour
    const shuffledCollections = [...collections].sort(() => Math.random() - 0.5);
    
    for (let collection of shuffledCollections) {
      if (articlesByCollection[collection][i]) {
        mixedArticles.push(articlesByCollection[collection][i]);
      }
    }
  }
  
  return mixedArticles;
})

// Configuration des couleurs par catégorie
const categoryColors = {
  'glp1-perte-de-poids': { bg: 'emerald', text: 'emerald-800', badge: 'emerald-100' },
  'glp1-diabete': { bg: 'blue', text: 'blue-800', badge: 'blue-100' },
  'glp1-cout': { bg: 'amber', text: 'amber-800', badge: 'amber-100' },
  'effets-secondaires-glp1': { bg: 'red', text: 'red-800', badge: 'red-100' },
  'alternatives-glp1': { bg: 'purple', text: 'purple-800', badge: 'purple-100' },
  'medicaments-glp1': { bg: 'indigo', text: 'indigo-800', badge: 'indigo-100' },
  'regime-glp1': { bg: 'orange', text: 'orange-800', badge: 'orange-100' },
  'avant-apres-glp1': { bg: 'pink', text: 'pink-800', badge: 'pink-100' },
  'recherche-glp1': { bg: 'teal', text: 'teal-800', badge: 'teal-100' },
  'medecins-glp1-france': { bg: 'slate', text: 'slate-800', badge: 'slate-100' }
}

// Configuration des noms de catégories
const categoryNames = {
  'glp1-perte-de-poids': 'Perte de poids',
  'glp1-diabete': 'Diabète',
  'glp1-cout': 'Prix et coûts',
  'effets-secondaires-glp1': 'Effets secondaires',
  'alternatives-glp1': 'Alternatives',
  'medicaments-glp1': 'Médicaments',
  'regime-glp1': 'Régime et nutrition',
  'avant-apres-glp1': 'Témoignages',
  'recherche-glp1': 'Recherche scientifique',
  'medecins-glp1-france': 'Médecins en France'
}
---

<BaseLayout 
  title="Tous les articles sur les GLP-1 - Guide complet" 
  description="Découvrez tous nos articles sur les médicaments GLP-1 : perte de poids, diabète, effets secondaires, prix, médecins en France et bien plus."
>
  <main class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50">
    <!-- Header Section -->
    <section class="relative py-16 bg-gradient-to-r from-emerald-600 via-teal-600 to-blue-600">
      <div class="absolute inset-0 bg-black/10"></div>
      <div class="container mx-auto px-4 relative">
        <div class="max-w-4xl mx-auto text-center">
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-6 leading-tight">
            Tous les articles sur les <span class="text-emerald-200">GLP-1</span>
          </h1>
          <p class="text-xl md:text-2xl text-emerald-50 mb-8 leading-relaxed">
            Découvrez notre collection complète d'articles sur les médicaments GLP-1 : 
            guides pratiques, témoignages, recherches scientifiques et conseils d'experts.
          </p>
          <div class="bg-white/20 backdrop-blur-sm rounded-2xl p-6 inline-block border border-white/30">
            <p class="text-2xl font-bold text-white">
              <span class="text-4xl text-emerald-200">{allArticles.length}</span> articles disponibles
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Articles Grid -->
    <section class="py-16">
      <div class="container mx-auto px-4">
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 max-w-7xl mx-auto">
          {allArticles.map((article) => {
            const colors = categoryColors[article.collection] || categoryColors['glp1-perte-de-poids']
            const categoryName = categoryNames[article.collection] || article.collection
            
            return (
              <ArticleCard 
                article={article}
                collection={article.collection}
                categoryName={categoryName}
                colors={colors}
              />
            )
          })}
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-16 bg-gradient-to-r from-emerald-600 via-teal-600 to-blue-600 relative overflow-hidden">
      <div class="absolute inset-0 bg-black/10"></div>
      <div class="container mx-auto px-4 text-center relative">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-6 leading-tight">
            Besoin d'informations spécifiques ?
          </h2>
          <p class="text-xl md:text-2xl text-emerald-50 mb-10 leading-relaxed">
            Téléchargez notre guide complet sur la beauté et la perte de poids avec les GLP-1
          </p>
          <a 
            href="/guide-beaute-perte-de-poids-glp1/" 
            class="inline-flex items-center px-8 py-4 bg-white text-emerald-700 font-bold rounded-xl hover:bg-emerald-50 transition-all duration-300 transform hover:scale-105 shadow-2xl text-lg"
          >
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Télécharger le guide gratuit
          </a>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
