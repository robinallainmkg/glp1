---
import { getCollection } from 'astro:content';

// === DONN√âES STATISTIQUES ===
function countWords(text) {
  if (!text) return 0;
  return text
    .replace(/`{3}[\s\S]*?`{3}/g, ' ')
    .replace(/`[^`]*`/g, ' ')
    .replace(/<[^>]+>/g, ' ')
    .split(/\s+/)
    .filter(Boolean)
    .length;
}

function countOccurrences(text, keyword) {
  if (!keyword) return 0;
  const escaped = keyword.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
  const regex = new RegExp(`\\b${escaped}\\b`, 'gi');
  return (text.match(regex) || []).length;
}

function countHeadings(md, level) {
  const hashes = '#'.repeat(level);
  const regex = new RegExp(`^${hashes}\\s+.+`, 'gm');
  return (md.match(regex) || []).length;
}

function hasKeywordInHeading(md, keyword, level) {
  if (!keyword) return false;
  const hashes = '#'.repeat(level);
  const regex = new RegExp(`^${hashes}\\s+.*${keyword.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')}.*`, 'gim');
  return regex.test(md);
}

function hasMedicalDisclaimer(md) {
  const disclaimerKeywords = ['avis m√©dical', 'professionnel de sant√©', 'm√©decin', 'consultation', 'prescription'];
  return disclaimerKeywords.some(keyword => md.toLowerCase().includes(keyword));
}

function hasInternalLinks(md) {
  const internalLinks = md.match(/\[([^\]]+)\]\(\/[^)]*\)/g) || [];
  return internalLinks.length;
}

// === COLLECTE DES DONN√âES ===
let detailedStats = [];
let totalArticles = 0;
let emptyArticles = 0;

// Toujours collecter les donn√©es - l'auth se fait c√¥t√© client
const collectionNames = [
  'alternatives-glp1',
  'glp1-perte-de-poids', 
  'effets-secondaires-glp1',
  'glp1-cout',
  'glp1-diabete',
  'medecins-glp1-france',
  'medicaments-glp1',
  'recherche-glp1',
  'regime-glp1'
];

const allEntries = [];
for (const name of collectionNames) {
  try {
    const entries = await getCollection(name);
    allEntries.push(...entries.map(e => ({ ...e, _collection: name })));
  } catch (e) {
    // ignore missing collection
    }
  }

  // Analyse de chaque article
  detailedStats = allEntries.map(article => {
    const md = article.body || '';
    const text = md.replace(/![^\n]*\n?/g, ' ')
                   .replace(/\[[^\]]*\]\([^)]*\)/g, ' ')
                   .replace(/<[^>]+>/g, ' ');

    const wordCount = countWords(text);
    const mainKeyword = article.data.mainKeyword || '';
    
    const mainKeywordCount = countOccurrences(text, mainKeyword);
    const mainKeywordDensity = mainKeyword ? 
      ((mainKeywordCount / Math.max(wordCount, 1)) * 100).toFixed(2) : '0.00';

    // Score SEO
    let score = 0;
    if (countHeadings(md, 1) === 1) score += 20;
    if (countHeadings(md, 2) >= 3) score += 15;
    if (wordCount >= 1000) score += 20;
    if (parseFloat(mainKeywordDensity) >= 1 && parseFloat(mainKeywordDensity) <= 2) score += 20;
    if (hasMedicalDisclaimer(md)) score += 10;
    if (hasInternalLinks(md) >= 3) score += 15;

    return {
      collection: article._collection,
      slug: article.slug,
      title: article.data.title || 'Sans titre',
      wordCount,
      mainKeyword,
      mainKeywordDensity: parseFloat(mainKeywordDensity),
      h1Count: countHeadings(md, 1),
      h2Count: countHeadings(md, 2),
      hasMedicalDisclaimer: hasMedicalDisclaimer(md),
      internalLinksCount: hasInternalLinks(md),
      seoScore: score,
      isEmpty: wordCount < 200
    };
  });

  // Statistiques globales
  totalArticles = detailedStats.length;
  emptyArticles = detailedStats.filter(s => s.isEmpty).length;
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Prot√©g√© - GLP-1 France</title>
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: #f8f9fa; 
    }
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .login-form {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
      min-width: 300px;
    }
    .login-form h2 {
      margin-bottom: 30px;
      color: #333;
    }
    .login-form input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .login-form button {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    .login-form button:hover {
      background: #5a6fd8;
    }
    .error-message {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }
    .hidden {
      display: none !important;
    }
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
    }
    .header { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      padding: 30px; 
      border-radius: 12px; 
      margin-bottom: 30px; 
    }
    .header h1 { 
      margin: 0; 
      font-size: 2.5em; 
      font-weight: 300; 
    }
    .header p { 
      margin: 10px 0 0 0; 
      opacity: 0.9; 
      font-size: 1.1em; 
    }
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 20px; 
      margin-bottom: 30px; 
    }
    .stat-card { 
      background: white; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      text-align: center; 
    }
    .stat-number { 
      font-size: 2.5em; 
      font-weight: bold; 
      margin-bottom: 10px; 
    }
    .stat-label { 
      color: #666; 
      font-size: 1.1em; 
    }
    .red { color: #dc3545; }
    .green { color: #28a745; }
    .roadmap-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .roadmap-phase {
      border-radius: 8px;
      margin-bottom: 30px;
      padding: 25px;
      transition: transform 0.2s ease;
    }
    .roadmap-phase:hover {
      transform: translateX(5px);
    }
    .roadmap-phase h4 {
      font-size: 1.3em;
      margin-bottom: 15px;
      margin-top: 0;
    }
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <!-- Formulaire de connexion -->
  <div id="login-container" class="login-container">
    <form id="login-form" class="login-form">
      <h2>üîí Acc√®s Dashboard</h2>
      <div id="error-message" class="error-message">Mot de passe incorrect. Veuillez r√©essayer.</div>
      <input type="password" id="password-input" placeholder="Mot de passe" required />
      <button type="submit">Se connecter</button>
    </form>
  </div>
  
  <!-- Dashboard principal -->
  <div id="dashboard-container" class="container hidden">
    <button id="logout-btn" class="logout-btn">üö™ D√©connexion</button>
      
      <div class="header">
        <h1>üè• Dashboard Prot√©g√© - GLP-1 France</h1>
        <p>Monitoring complet ‚Ä¢ Roadmap ‚Ä¢ Mon√©tisation</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{totalArticles}</div>
          <div class="stat-label">Articles total</div>
        </div>
        <div class="stat-card">
          <div class="stat-number red">{emptyArticles}</div>
          <div class="stat-label">Articles vides</div>
        </div>
        <div class="stat-card">
          <div class="stat-number green">{totalArticles - emptyArticles}</div>
          <div class="stat-label">Articles publi√©s</div>
        </div>
      </div>

      <div class="roadmap-section">
        <h3>üöÄ Roadmap - Affiliation et Mon√©tisation</h3>
        
        <div class="roadmap-phase" style="border-left: 5px solid #667eea; background: #f8f9ff;">
          <h4 style="color: #667eea;">üìã Phase 1 : Affiliation</h4>
          <p><strong>Objectif :</strong> Int√©grer des partenariats d'affiliation pertinents</p>
          <ul style="line-height: 1.8;">
            <li><strong>Prospection d'affiliations :</strong>
              <ul>
                <li>Plateformes d'affiliation (Amazon, CJ Affiliate, ShareASale)</li>
                <li>Sites de cosm√©tiques et bien-√™tre (Sephora, Douglas, etc.)</li>
                <li>Compl√©ments alimentaires (Nutrimea, Biovancia)</li>
                <li>Pharmacies en ligne (Doctipharma, PharmashopDiscount)</li>
              </ul>
            </li>
            <li><strong>Cr√©ation de banni√®res :</strong>
              <ul>
                <li>Banni√®res contextuelles dans les articles</li>
                <li>Sidebar avec produits recommand√©s</li>
                <li>Call-to-action en fin d'articles</li>
                <li>Int√©gration native dans le contenu</li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="roadmap-phase" style="border-left: 5px solid #28a745; background: #f8fff8;">
          <h4 style="color: #28a745;">üìß Phase 2 : Collecte de Donn√©es Utilisateurs</h4>
          <p><strong>Objectif :</strong> Constituer une base de donn√©es qualifi√©e avec l'email comme identifiant unique</p>
          <ul style="line-height: 1.8;">
            <li><strong>Points de collecte :</strong>
              <ul>
                <li>Newsletter footer (existant - √† optimiser)</li>
                <li>Pop-up d'inscription strat√©gique</li>
                <li>Formulaire de t√©l√©chargement du guide PDF</li>
                <li>Commentaires et questions d'articles</li>
                <li>Quiz interactifs sur les traitements</li>
              </ul>
            </li>
            <li><strong>Base de donn√©es :</strong>
              <ul>
                <li>Email (identifiant unique)</li>
                <li>Pr√©nom / Nom</li>
                <li>√Çge / Tranche d'√¢ge</li>
                <li>Localisation (r√©gion/d√©partement)</li>
                <li>Traitement actuel / Int√©r√™t</li>
                <li>Source d'acquisition</li>
                <li>Date d'inscription</li>
                <li>Historique d'engagement</li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="roadmap-phase" style="border-left: 5px solid #ffc107; background: #fffef8;">
          <h4 style="color: #f39c12;">üìñ Phase 3 : Guide PDF Complet</h4>
          <p><strong>Objectif :</strong> Cr√©er un guide de r√©f√©rence A-Z pour traiter les effets secondaires</p>
          <ul style="line-height: 1.8;">
            <li><strong>Contenu du guide :</strong>
              <ul>
                <li>Classification des effets secondaires par gravit√©</li>
                <li>Solutions naturelles et m√©dicamenteuses</li>
                <li>Protocoles de gestion par sympt√¥me</li>
                <li>Quand consulter un professionnel</li>
                <li>T√©moignages et cas pratiques</li>
                <li>Check-lists et aide-m√©moires</li>
              </ul>
            </li>
            <li><strong>Mon√©tisation :</strong>
              <ul>
                <li>Lead magnet pour collecte d'emails</li>
                <li>Version premium payante</li>
                <li>Liens d'affiliation int√©gr√©s</li>
                <li>Mise √† jour r√©guli√®re</li>
              </ul>
            </li>
          </ul>
        </div>

        <div class="roadmap-phase" style="border-left: 5px solid #dc3545; background: #fff8f8;">
          <h4 style="color: #dc3545;">üè• Phase 4 : Annuaire de Professionnels</h4>
          <p><strong>Objectif :</strong> Cr√©er un annuaire complet des professionnels de sant√© sp√©cialis√©s</p>
          <ul style="line-height: 1.8;">
            <li><strong>Scraping et collecte :</strong>
              <ul>
                <li>Endocrinologues par ville/d√©partement/r√©gion</li>
                <li>Cliniques sp√©cialis√©es en ob√©sit√©</li>
                <li>Centres de diab√©tologie</li>
                <li>Nutritionnistes certifi√©s</li>
                <li>Sources : Pages Jaunes, Doctolib, ordre des m√©decins</li>
              </ul>
            </li>
            <li><strong>Donn√©es √† collecter :</strong>
              <ul>
                <li>Nom, pr√©nom, titre</li>
                <li>Sp√©cialit√©s et certifications</li>
                <li>Adresse compl√®te</li>
                <li>T√©l√©phone, email, site web</li>
                <li>Horaires et disponibilit√©s</li>
                <li>Acceptation secteur 1/2</li>
                <li>Langues parl√©es</li>
              </ul>
            </li>
            <li><strong>Mon√©tisation :</strong>
              <ul>
                <li>R√©f√©rencement payant des professionnels</li>
                <li>Publicit√©s g√©olocalis√©es</li>
                <li>Partenariats avec cliniques priv√©es</li>
                <li>Commission sur prises de rendez-vous</li>
              </ul>
            </li>
          </ul>
        </div>

        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 8px; text-align: center;">
          <h4 style="margin-top: 0;">üéØ Objectifs de Revenus</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div>
              <div style="font-size: 2em; font-weight: bold;">1000‚Ç¨</div>
              <div>Mois 1-3 (Affiliation)</div>
            </div>
            <div>
              <div style="font-size: 2em; font-weight: bold;">3000‚Ç¨</div>
              <div>Mois 4-6 (Guide + Base)</div>
            </div>
            <div>
              <div style="font-size: 2em; font-weight: bold;">5000‚Ç¨</div>
              <div>Mois 7-12 (Annuaire)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PASSWORD = "12031990Robin!";
    const AUTH_KEY = "admin-dashboard-auth";
    
    // √âl√©ments DOM
    const loginContainer = document.getElementById('login-container');
    const dashboardContainer = document.getElementById('dashboard-container');
    const loginForm = document.getElementById('login-form');
    const passwordInput = document.getElementById('password-input');
    const errorMessage = document.getElementById('error-message');
    const logoutBtn = document.getElementById('logout-btn');
    
    // V√©rifier l'authentification au chargement
    function checkAuth() {
      const authExpiry = localStorage.getItem(AUTH_KEY);
      const now = Date.now();
      
      if (authExpiry && now < parseInt(authExpiry)) {
        showDashboard();
      } else {
        localStorage.removeItem(AUTH_KEY);
        showLogin();
      }
    }
    
    // Afficher le formulaire de connexion
    function showLogin() {
      loginContainer.classList.remove('hidden');
      dashboardContainer.classList.add('hidden');
      errorMessage.style.display = 'none';
      passwordInput.focus();
    }
    
    // Afficher le dashboard
    function showDashboard() {
      loginContainer.classList.add('hidden');
      dashboardContainer.classList.remove('hidden');
    }
    
    // G√©rer la connexion
    loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const inputPassword = passwordInput.value;
      
      if (inputPassword === PASSWORD) {
        // Authentification r√©ussie - valable 24h
        const expiry = Date.now() + (24 * 60 * 60 * 1000);
        localStorage.setItem(AUTH_KEY, expiry.toString());
        showDashboard();
        passwordInput.value = '';
      } else {
        // Mot de passe incorrect
        errorMessage.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    });
    
    // G√©rer la d√©connexion
    logoutBtn.addEventListener('click', function() {
      localStorage.removeItem(AUTH_KEY);
      showLogin();
    });
    
    // Initialiser
    checkAuth();
  </script>
</body>
</html>
