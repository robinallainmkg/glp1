---
import { getCollection } from 'astro:content';

// Variables globales pour l'affiliation
let legacyAffiliateData = null;
let crudAffiliateData = { products: [], deals: [], partners: [], rules: [] };
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Affiliation - GLP-1 France</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: relative;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .back-link {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: background 0.3s ease;
    }

    .back-link:hover {
      background: rgba(255,255,255,0.3);
    }

    .tabs-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .tabs-header {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .tab-btn {
      flex: 1;
      padding: 15px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 16px;
      color: #6c757d;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: white;
      color: #10b981;
      border-bottom: 3px solid #10b981;
    }

    .tab-btn:hover {
      background: #e9ecef;
    }

    .tab-content {
      display: none;
      padding: 30px;
    }

    .tab-content.active {
      display: block;
    }

    .search-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      align-items: center;
    }

    .search-bar input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
    }

    .btn-primary {
      background: #10b981;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s ease;
    }

    .btn-primary:hover {
      background: #059669;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .table thead {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .table tr:hover {
      background: #f9fafb;
    }

    /* Modales */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 0;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      padding: 20px 30px;
      border-top: 1px solid #e5e7eb;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1001;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification-success { background: #10b981; }
    .notification-error { background: #ef4444; }
    .notification-info { background: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/admin-dashboard" class="back-link">‚Üê Retour au Dashboard</a>
      <h1>üí∞ Gestion de l'Affiliation</h1>
      <p>Partenaires ‚Ä¢ Deals ‚Ä¢ Produits ‚Ä¢ R√®gles de placement</p>
    </div>

    <div class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" data-tab="deals">üí∞ Deals</button>
        <button class="tab-btn" data-tab="partners">ü§ù Partenaires</button>
        <button class="tab-btn" data-tab="rules">üìã R√®gles & Preview</button>
        <button class="tab-btn" data-tab="legacy">üìä Produits Legacy</button>
      </div>

      <!-- TAB: DEALS -->
      <div class="tab-content active" id="tab-deals">
        <div class="search-bar">
          <input type="text" id="deals-search" placeholder="Rechercher des deals...">
          <button onclick="openDealModal()" class="btn-primary">‚ûï Nouveau Deal</button>
        </div>
        
        <table class="table">
          <thead>
            <tr>
              <th>Deal</th>
              <th>Partenaire</th>
              <th>Type</th>
              <th>Valeur</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="deals-tbody">
            <!-- Contenu g√©n√©r√© dynamiquement -->
          </tbody>
        </table>
      </div>

      <!-- TAB: PARTENAIRES -->
      <div class="tab-content" id="tab-partners">
        <div class="search-bar">
          <input type="text" id="partners-search" placeholder="Rechercher des partenaires...">
          <button onclick="openPartnerModal()" class="btn-primary">‚ûï Nouveau Partenaire</button>
        </div>
        
        <div id="partners-grid" class="grid">
          <!-- Contenu g√©n√©r√© dynamiquement -->
        </div>
      </div>

      <!-- TAB: R√àGLES & PREVIEW -->
      <div class="tab-content" id="tab-rules">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
          <!-- Section R√®gles -->
          <div>
            <h4 style="margin: 0 0 1rem 0; color: #374151;">üìã R√®gles de Placement</h4>
            <div style="margin-bottom: 1rem;">
              <button onclick="openRuleModal()" class="btn-primary">‚ûï Nouvelle R√®gle</button>
            </div>
            <div id="rules-list" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
              <p style="color: #6b7280; text-align: center;">Aucune r√®gle d√©finie</p>
            </div>
          </div>
          
          <!-- Section Preview -->
          <div>
            <h4 style="margin: 0 0 1rem 0; color: #374151;">üîç Pr√©visualisation</h4>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Chemin de test :</label>
              <input type="text" id="preview-path" placeholder="/articles/effets-secondaires-glp1" value="/articles/effets-secondaires-glp1" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Tags :</label>
              <input type="text" id="preview-tags" placeholder="glp1,ozempic,effets-secondaires" value="glp1,effets-secondaires" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
            </div>
            <button onclick="runPreview()" style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 500; width: 100%;">
              üîç Pr√©visualiser
            </button>
            
            <div id="preview-results" style="margin-top: 1.5rem;">
              <!-- Contenu g√©n√©r√© dynamiquement -->
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: LEGACY PRODUCTS -->
      <div class="tab-content" id="tab-legacy">
        <div style="margin-bottom: 1rem;">
          <h3>üìä Produits Legacy</h3>
          <p style="color: #6b7280;">Ancienne gestion des produits d'affiliation</p>
        </div>
        
        <div class="search-bar">
          <button onclick="refreshLegacyData()" class="btn-secondary">üîÑ Actualiser</button>
          <button onclick="showAddProductModal()" class="btn-primary">‚ûï Ajouter Produit</button>
        </div>
        
        <table class="table">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Marque</th>
              <th>Prix</th>
              <th>Collections</th>
              <th>Priorit√©</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="legacy-products-tbody">
            <!-- Contenu g√©n√©r√© dynamiquement -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modale Deal -->
  <div id="deal-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin: 0; color: #1f2937;">üìù <span id="deal-modal-title">Nouveau Deal</span></h3>
        <button onclick="closeDealModal()" class="modal-close">√ó</button>
      </div>
      <div class="modal-body">
        <form id="deal-form">
          <div class="form-group">
            <label for="deal-name">Nom du deal :</label>
            <input type="text" id="deal-name" required>
          </div>
          <div class="form-group">
            <label for="deal-partner">Partenaire :</label>
            <select id="deal-partner" required>
              <option value="">S√©lectionner un partenaire</option>
              <option value="amazon">Amazon</option>
              <option value="sephora">Sephora</option>
              <option value="doctipharma">Doctipharma</option>
            </select>
          </div>
          <div class="form-group">
            <label for="deal-type">Type de deal :</label>
            <select id="deal-type" required>
              <option value="percentage">Pourcentage</option>
              <option value="fixed">Montant fixe</option>
              <option value="special">Offre sp√©ciale</option>
            </select>
          </div>
          <div class="form-group">
            <label for="deal-value">Valeur :</label>
            <input type="text" id="deal-value" placeholder="Ex: 10%, 5‚Ç¨, Code promo" required>
          </div>
          <div class="form-group">
            <label for="deal-status">Statut :</label>
            <select id="deal-status" required>
              <option value="active">Actif</option>
              <option value="inactive">Inactif</option>
              <option value="pending">En attente</option>
            </select>
          </div>
          <div class="form-group">
            <label for="deal-start">Date de d√©but :</label>
            <input type="date" id="deal-start" required>
          </div>
          <div class="form-group">
            <label for="deal-end">Date de fin :</label>
            <input type="date" id="deal-end">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDealModal()" class="btn-secondary">Annuler</button>
        <button type="submit" form="deal-form" class="btn-primary">Sauvegarder</button>
      </div>
    </div>
  </div>

  <!-- Modale Partenaire -->
  <div id="partner-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin: 0; color: #1f2937;">ü§ù <span id="partner-modal-title">Nouveau Partenaire</span></h3>
        <button onclick="closePartnerModal()" class="modal-close">√ó</button>
      </div>
      <div class="modal-body">
        <form id="partner-form">
          <div class="form-group">
            <label for="partner-name">Nom du partenaire :</label>
            <input type="text" id="partner-name" required>
          </div>
          <div class="form-group">
            <label for="partner-website">Site web :</label>
            <input type="url" id="partner-website" required>
          </div>
          <div class="form-group">
            <label for="partner-contact">Contact :</label>
            <input type="email" id="partner-contact" required>
          </div>
          <div class="form-group">
            <label for="partner-commission">Commission :</label>
            <input type="text" id="partner-commission" placeholder="Ex: 5%, 10‚Ç¨ par vente" required>
          </div>
          <div class="form-group">
            <label for="partner-category">Cat√©gorie :</label>
            <select id="partner-category" required>
              <option value="e-commerce">E-commerce</option>
              <option value="pharmacie">Pharmacie</option>
              <option value="cosmetique">Cosm√©tique</option>
              <option value="complement">Compl√©ment alimentaire</option>
              <option value="autre">Autre</option>
            </select>
          </div>
          <div class="form-group">
            <label for="partner-status">Statut :</label>
            <select id="partner-status" required>
              <option value="active">Actif</option>
              <option value="inactive">Inactif</option>
              <option value="negotiation">En n√©gociation</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closePartnerModal()" class="btn-secondary">Annuler</button>
        <button type="submit" form="partner-form" class="btn-primary">Sauvegarder</button>
      </div>
    </div>
  </div>

  <script>
    // === GESTION DES TABULATIONS ===
    function initTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');
          
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          this.classList.add('active');
          document.getElementById('tab-' + targetTab).classList.add('active');
        });
      });
    }

    // === GESTION DES MODALES ===
    function openDealModal(deal = null) {
      const modal = document.getElementById('deal-modal');
      const title = document.getElementById('deal-modal-title');
      
      if (deal) {
        title.textContent = 'Modifier le Deal';
        document.getElementById('deal-name').value = deal.name || '';
        document.getElementById('deal-partner').value = deal.partner || '';
        document.getElementById('deal-type').value = deal.type || '';
        document.getElementById('deal-value').value = deal.value || '';
        document.getElementById('deal-status').value = deal.status || '';
        document.getElementById('deal-start').value = deal.startDate || '';
        document.getElementById('deal-end').value = deal.endDate || '';
      } else {
        title.textContent = 'Nouveau Deal';
        document.getElementById('deal-form').reset();
      }
      
      modal.style.display = 'flex';
    }

    function closeDealModal() {
      document.getElementById('deal-modal').style.display = 'none';
    }

    function openPartnerModal(partner = null) {
      const modal = document.getElementById('partner-modal');
      const title = document.getElementById('partner-modal-title');
      
      if (partner) {
        title.textContent = 'Modifier le Partenaire';
        document.getElementById('partner-name').value = partner.name || '';
        document.getElementById('partner-website').value = partner.website || '';
        document.getElementById('partner-contact').value = partner.contact || '';
        document.getElementById('partner-commission').value = partner.commission || '';
        document.getElementById('partner-category').value = partner.category || '';
        document.getElementById('partner-status').value = partner.status || '';
      } else {
        title.textContent = 'Nouveau Partenaire';
        document.getElementById('partner-form').reset();
      }
      
      modal.style.display = 'flex';
    }

    function closePartnerModal() {
      document.getElementById('partner-modal').style.display = 'none';
    }

    // === FONCTIONS DE DONN√âES ===
    function refreshLegacyData() {
      const products = JSON.parse(localStorage.getItem('affiliate_products') || '[]');
      const tbody = document.getElementById('legacy-products-tbody');
      
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">Aucun produit ajout√©</td></tr>';
        return;
      }
      
      tbody.innerHTML = products.map(product => `
        <tr>
          <td>
            <strong>${product.name}</strong>
            <br><small style="color: #6b7280;">${product.description || 'Pas de description'}</small>
          </td>
          <td>${product.brand}</td>
          <td>${product.price}‚Ç¨</td>
          <td><span style="background: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${product.collections?.length || 0} collections</span></td>
          <td>${product.priority}</td>
          <td>
            <span style="background: ${product.status === 'active' ? '#dcfce7' : '#fef2f2'}; color: ${product.status === 'active' ? '#166534' : '#dc2626'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
              ${product.status === 'active' ? '‚úÖ Actif' : '‚ùå Inactif'}
            </span>
          </td>
          <td>
            <button onclick="editProduct('${product.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; margin-right: 0.25rem; cursor: pointer;">√âditer</button>
            <button onclick="deleteProduct('${product.id}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Supprimer</button>
          </td>
        </tr>
      `).join('');
    }

    function loadDeals() {
      const deals = JSON.parse(localStorage.getItem('affiliate_deals') || '[]');
      const tbody = document.getElementById('deals-tbody');
      
      if (deals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280; padding: 2rem;">Aucun deal cr√©√©</td></tr>';
        return;
      }
      
      tbody.innerHTML = deals.map(deal => `
        <tr>
          <td><strong>${deal.name}</strong></td>
          <td>${deal.partner}</td>
          <td>
            <span style="background: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
              ${deal.type}
            </span>
          </td>
          <td>${deal.value}</td>
          <td>
            <span style="background: ${deal.status === 'active' ? '#dcfce7' : '#fef2f2'}; color: ${deal.status === 'active' ? '#166534' : '#dc2626'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
              ${deal.status === 'active' ? '‚úÖ Actif' : '‚ùå Inactif'}
            </span>
          </td>
          <td>
            <button onclick="editDeal('${deal.id}')" style="background: #f59e0b; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; margin-right: 0.25rem; cursor: pointer;">√âditer</button>
            <button onclick="deleteDeal('${deal.id}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Supprimer</button>
          </td>
        </tr>
      `).join('');
    }

    function loadPartners() {
      const partners = JSON.parse(localStorage.getItem('affiliate_partners') || '[]');
      const grid = document.getElementById('partners-grid');
      
      if (partners.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">Aucun partenaire ajout√©</div>';
        return;
      }
      
      grid.innerHTML = partners.map(partner => `
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">${partner.name}</h4>
              <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">${partner.category}</p>
            </div>
            <span style="background: ${partner.status === 'active' ? '#dcfce7' : '#fef2f2'}; color: ${partner.status === 'active' ? '#166534' : '#dc2626'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
              ${partner.status === 'active' ? '‚úÖ Actif' : '‚ùå Inactif'}
            </span>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <p style="margin: 0 0 0.25rem 0; color: #374151; font-size: 0.875rem;"><strong>Site :</strong> <a href="${partner.website}" target="_blank" style="color: #3b82f6;">${partner.website}</a></p>
            <p style="margin: 0 0 0.25rem 0; color: #374151; font-size: 0.875rem;"><strong>Contact :</strong> ${partner.contact}</p>
            <p style="margin: 0; color: #374151; font-size: 0.875rem;"><strong>Commission :</strong> ${partner.commission}</p>
          </div>
          
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="editPartner('${partner.id}')" style="flex: 1; background: #f59e0b; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">√âditer</button>
            <button onclick="deletePartner('${partner.id}')" style="flex: 1; background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">Supprimer</button>
          </div>
        </div>
      `).join('');
    }

    // === FONCTIONS D'ACTION ===
    function showAddProductModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>‚ûï Nouveau Produit</h3>
            <button onclick="this.closest('.modal').remove()" class="modal-close">√ó</button>
          </div>
          <div class="modal-body">
            <form id="product-form">
              <div class="form-group">
                <label>Nom du produit :</label>
                <input type="text" id="product-name" required>
              </div>
              <div class="form-group">
                <label>Marque :</label>
                <input type="text" id="product-brand" required>
              </div>
              <div class="form-group">
                <label>Prix :</label>
                <input type="number" id="product-price" step="0.01" required>
              </div>
              <div class="form-group">
                <label>Lien d'affiliation :</label>
                <input type="url" id="product-link" required>
              </div>
              <div class="form-group">
                <label>Description :</label>
                <textarea id="product-description" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" onclick="this.closest('.modal').remove()" class="btn-secondary">Annuler</button>
            <button type="submit" form="product-form" class="btn-primary">Cr√©er le produit</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('product-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const product = {
          id: 'prod-' + Date.now(),
          name: document.getElementById('product-name').value,
          brand: document.getElementById('product-brand').value,
          price: parseFloat(document.getElementById('product-price').value),
          link: document.getElementById('product-link').value,
          description: document.getElementById('product-description').value,
          status: 'active',
          priority: 1,
          collections: [],
          created: new Date().toISOString()
        };
        
        const products = JSON.parse(localStorage.getItem('affiliate_products') || '[]');
        products.push(product);
        localStorage.setItem('affiliate_products', JSON.stringify(products));
        
        showNotification('Produit cr√©√© avec succ√®s !', 'success');
        modal.remove();
        refreshLegacyData();
      });
    }

    function openRuleModal() {
      showNotification('Fonction √† impl√©menter', 'info');
    }

    function runPreview() {
      const path = document.getElementById('preview-path').value;
      const tags = document.getElementById('preview-tags').value;
      
      const resultsDiv = document.getElementById('preview-results');
      resultsDiv.innerHTML = `
        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background: #f9fafb;">
          <h4 style="color: #374151; margin-bottom: 0.5rem;">üîç R√©sultat de la pr√©visualisation</h4>
          <p><strong>Chemin :</strong> ${path}</p>
          <p><strong>Tags :</strong> ${tags}</p>
          <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px;">
            <p style="color: #92400e; margin: 0;">üí° <strong>Produits sugg√©r√©s :</strong> Compl√©ments alimentaires, Balances connect√©es, Guides nutritionnels</p>
          </div>
        </div>
      `;
    }

    function deleteProduct(id) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
        const products = JSON.parse(localStorage.getItem('affiliate_products') || '[]');
        const filtered = products.filter(p => p.id !== id);
        localStorage.setItem('affiliate_products', JSON.stringify(filtered));
        showNotification('Produit supprim√©', 'success');
        refreshLegacyData();
      }
    }

    function deleteDeal(id) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce deal ?')) {
        const deals = JSON.parse(localStorage.getItem('affiliate_deals') || '[]');
        const filtered = deals.filter(d => d.id !== id);
        localStorage.setItem('affiliate_deals', JSON.stringify(filtered));
        showNotification('Deal supprim√©', 'success');
        loadDeals();
      }
    }

    function deletePartner(id) {
      if (confirm('√ätes-vous s√ªr de vouloir supprimer ce partenaire ?')) {
        const partners = JSON.parse(localStorage.getItem('affiliate_partners') || '[]');
        const filtered = partners.filter(p => p.id !== id);
        localStorage.setItem('affiliate_partners', JSON.stringify(filtered));
        showNotification('Partenaire supprim√©', 'success');
        loadPartners();
      }
    }

    function editProduct(id) {
      showNotification('Fonction d\'√©dition √† impl√©menter', 'info');
    }

    function editDeal(id) {
      showNotification('Fonction d\'√©dition √† impl√©menter', 'info');
    }

    function editPartner(id) {
      showNotification('Fonction d\'√©dition √† impl√©menter', 'info');
    }

    // === GESTION DES FORMULAIRES ===
    document.getElementById('deal-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const deal = {
        id: 'deal-' + Date.now(),
        name: document.getElementById('deal-name').value,
        partner: document.getElementById('deal-partner').value,
        type: document.getElementById('deal-type').value,
        value: document.getElementById('deal-value').value,
        status: document.getElementById('deal-status').value,
        startDate: document.getElementById('deal-start').value,
        endDate: document.getElementById('deal-end').value,
        created: new Date().toISOString()
      };
      
      const deals = JSON.parse(localStorage.getItem('affiliate_deals') || '[]');
      deals.push(deal);
      localStorage.setItem('affiliate_deals', JSON.stringify(deals));
      
      showNotification('Deal cr√©√© avec succ√®s !', 'success');
      closeDealModal();
      loadDeals();
    });

    document.getElementById('partner-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const partner = {
        id: 'partner-' + Date.now(),
        name: document.getElementById('partner-name').value,
        website: document.getElementById('partner-website').value,
        contact: document.getElementById('partner-contact').value,
        commission: document.getElementById('partner-commission').value,
        status: document.getElementById('partner-status').value,
        category: document.getElementById('partner-category').value,
        created: new Date().toISOString()
      };
      
      const partners = JSON.parse(localStorage.getItem('affiliate_partners') || '[]');
      partners.push(partner);
      localStorage.setItem('affiliate_partners', JSON.stringify(partners));
      
      showNotification('Partenaire cr√©√© avec succ√®s !', 'success');
      closePartnerModal();
      loadPartners();
    });

    // === FERMETURE DES MODALES EN CLIQUANT √Ä L'EXT√âRIEUR ===
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });
    });

    // === NOTIFICATIONS ===
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification notification-' + type;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // === INITIALISATION ===
    document.addEventListener('DOMContentLoaded', function() {
      initTabs();
      loadDeals();
      loadPartners();
      refreshLegacyData();
      showNotification('Page d\'affiliation charg√©e', 'success');
    });
  </script>
</body>
</html>
