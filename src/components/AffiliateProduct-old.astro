---
import { getProductById, addUtmParameters } from '../utils/affiliate-manager.ts';

export interface Props {
  productId: string;
  placement: 'banner' | 'sidebar' | 'inline' | 'grid' | 'footer' | 'content';
  variant?: 'featured' | 'expanded' | 'compact' | 'card';
  context?: {
    category?: string;
    keywords?: string[];
    tags?: string[];
  };
  className?: string;
  showIfRelevant?: boolean;
}

const { 
  productId, 
  placement, 
  variant = 'expanded', 
  context = {}, 
  className = '',
  showIfRelevant = true 
} = Astro.props;

// Récupération du produit par ID
const product = await getProductById(productId);

// Si le produit n'existe pas, ne rien afficher
if (!product) {
  return null;
}

// Si showIfRelevant est activé, vérifier la pertinence contextuelle
if (showIfRelevant && context.keywords?.length) {
  const isRelevant = product.contextualKeywords.some(keyword => 
    context.keywords!.some(ctxKeyword => 
      keyword.toLowerCase().includes(ctxKeyword.toLowerCase()) ||
      ctxKeyword.toLowerCase().includes(keyword.toLowerCase())
    )
  );
  
  if (!isRelevant) {
    return null;
  }
}

// Configuration du placement
const placementConfig = product.placements?.[placement];
if (!placementConfig?.enabled) {
  return null;
}

// Génération de l'URL avec UTM
const utmUrl = addUtmParameters(product.affiliateUrl, {
  source: 'glp1-france',
  medium: 'affiliate',
  campaign: placement,
  content: productId
});

// Générer les classes CSS dynamiquement
const containerClasses = [
  'affiliate-product',
  `affiliate-product--${position}`,
  `affiliate-product--${style}`
].join(' ');

// Schema.org structured data pour SEO
const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": name,
  "brand": {
    "@type": "Brand",
    "name": brand
  },
  "description": description,
  "image": image,
  "offers": {
    "@type": "Offer",
    "price": price.replace('€', '').trim(),
    "priceCurrency": "EUR",
    "availability": "https://schema.org/InStock",
    "url": affiliateUrl
  },
  "aggregateRating": rating && reviews ? {
    "@type": "AggregateRating",
    "ratingValue": rating,
    "reviewCount": reviews
  } : undefined
};
---

<div class={containerClasses} data-product-id={id}>
  {showBadge && (
    <div class="affiliate-badge">
      <span class="badge-icon">✨</span>
      <span class="badge-text">Recommandé</span>
    </div>
  )}
  
  <div class="affiliate-product__content">
    <div class="affiliate-product__media">
      <img 
        src={image} 
        alt={name}
        class="affiliate-product__image"
        loading="lazy"
        width="300"
        height="300"
      >
      {discount && (
        <div class="affiliate-product__discount">
          -{discount}
        </div>
      )}
    </div>
    
    <div class="affiliate-product__info">
      <div class="affiliate-product__header">
        <span class="affiliate-product__brand">{brand}</span>
        <h3 class="affiliate-product__name">{name}</h3>
      </div>
      
      {rating && reviews > 0 && (
        <div class="affiliate-product__rating">
          <div class="rating-stars">
            {Array.from({length: 5}, (_, i) => (
              <span class={`star ${i < Math.floor(rating) ? 'star--filled' : ''}`}>★</span>
            ))}
          </div>
          <span class="rating-text">{rating} ({reviews} avis)</span>
        </div>
      )}
      
      <p class="affiliate-product__description">{description}</p>
      
      {benefits.length > 0 && (
        <ul class="affiliate-product__benefits">
          {benefits.map(benefit => (
            <li class="benefit-item">
              <span class="benefit-icon">✓</span>
              <span class="benefit-text">{benefit}</span>
            </li>
          ))}
        </ul>
      )}
      
      <div class="affiliate-product__pricing">
        {originalPrice && (
          <span class="price price--original">{originalPrice}</span>
        )}
        <span class="price price--current">{price}</span>
      </div>
      
      <div class="affiliate-product__actions">
        <a 
          href={affiliateUrl}
          class="btn btn--affiliate"
          target="_blank"
          rel="noopener nofollow"
          data-tracking={`affiliate-${id}-${position}`}
        >
          {ctaText}
          <span class="btn-icon">→</span>
        </a>
      </div>
      
      {tags.length > 0 && (
        <div class="affiliate-product__tags">
          {tags.map(tag => (
            <span class="product-tag">{tag}</span>
          ))}
        </div>
      )}
    </div>
  </div>
  
  <div class="affiliate-disclaimer">
    <small>* Lien affilié - Nous touchons une commission sans surcoût pour vous</small>
  </div>
</div>

<!-- Schema.org JSON-LD -->
<script type="application/ld+json" set:html={JSON.stringify(productSchema)}></script>

<style>
  /* Base styles */
  .affiliate-product {
    background: linear-gradient(135deg, #fef7cd 0%, #fcd34d 100%);
    border: 2px solid #f59e0b;
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 2rem 0;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .affiliate-product:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(245, 158, 11, 0.2);
  }
  
  /* Badge */
  .affiliate-badge {
    position: absolute;
    top: -8px;
    right: 1rem;
    background: linear-gradient(135deg, #059669, #10b981);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0 0 0.5rem 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
  }
  
  /* Content layout */
  .affiliate-product__content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 1.5rem;
    align-items: start;
  }
  
  /* Media */
  .affiliate-product__media {
    position: relative;
  }
  
  .affiliate-product__image {
    width: 100%;
    height: auto;
    border-radius: 0.75rem;
    object-fit: cover;
    aspect-ratio: 1;
  }
  
  .affiliate-product__discount {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: #dc2626;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 700;
  }
  
  /* Info section */
  .affiliate-product__header {
    margin-bottom: 1rem;
  }
  
  .affiliate-product__brand {
    color: #059669;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .affiliate-product__name {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0.25rem 0 0 0;
    line-height: 1.3;
  }
  
  /* Rating */
  .affiliate-product__rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .rating-stars {
    display: flex;
    gap: 0.125rem;
  }
  
  .star {
    color: #d1d5db;
    font-size: 1rem;
  }
  
  .star--filled {
    color: #fbbf24;
  }
  
  .rating-text {
    font-size: 0.875rem;
    color: #6b7280;
  }
  
  /* Description */
  .affiliate-product__description {
    color: #4b5563;
    line-height: 1.6;
    margin-bottom: 1rem;
  }
  
  /* Benefits */
  .affiliate-product__benefits {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
  }
  
  .benefit-item {
    display: flex;
    align-items: start;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .benefit-icon {
    color: #059669;
    font-weight: 700;
    flex-shrink: 0;
    margin-top: 0.125rem;
  }
  
  .benefit-text {
    color: #374151;
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  /* Pricing */
  .affiliate-product__pricing {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 1.5rem 0;
  }
  
  .price {
    font-weight: 700;
  }
  
  .price--original {
    color: #9ca3af;
    text-decoration: line-through;
    font-size: 1rem;
  }
  
  .price--current {
    color: #059669;
    font-size: 1.5rem;
  }
  
  /* Actions */
  .affiliate-product__actions {
    margin: 1.5rem 0;
  }
  
  .btn--affiliate {
    background: linear-gradient(135deg, #059669, #10b981);
    color: white;
    padding: 0.875rem 2rem;
    border-radius: 0.75rem;
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
  }
  
  .btn--affiliate:hover {
    background: linear-gradient(135deg, #047857, #059669);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(5, 150, 105, 0.4);
    text-decoration: none;
    color: white;
  }
  
  .btn-icon {
    transition: transform 0.3s ease;
  }
  
  .btn--affiliate:hover .btn-icon {
    transform: translateX(4px);
  }
  
  /* Tags */
  .affiliate-product__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .product-tag {
    background: rgba(5, 150, 105, 0.1);
    color: #059669;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  /* Disclaimer */
  .affiliate-disclaimer {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(245, 158, 11, 0.3);
  }
  
  .affiliate-disclaimer small {
    color: #92400e;
    font-style: italic;
  }
  
  /* Responsive variants */
  @media (max-width: 768px) {
    .affiliate-product__content {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .affiliate-product {
      padding: 1rem;
      margin: 1.5rem 0;
    }
    
    .affiliate-product__name {
      font-size: 1.125rem;
    }
    
    .btn--affiliate {
      width: 100%;
      justify-content: center;
    }
  }
  
  /* Style variants */
  .affiliate-product--banner {
    background: linear-gradient(90deg, #fef7cd 0%, #fcd34d 100%);
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    margin: 1rem 0;
  }
  
  .affiliate-product--banner .affiliate-product__content {
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: center;
  }
  
  .affiliate-product--compact {
    padding: 1rem;
    background: rgba(254, 247, 205, 0.5);
    border: 1px solid #fcd34d;
  }
  
  .affiliate-product--compact .affiliate-product__content {
    grid-template-columns: 80px 1fr;
    gap: 1rem;
  }
  
  .affiliate-product--sidebar {
    position: sticky;
    top: 2rem;
    background: white;
    border: 2px solid #f59e0b;
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.15);
  }
  
  /* Position variants */
  .affiliate-product--footer {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    color: white;
    border-color: #4b5563;
  }
  
  .affiliate-product--footer .affiliate-product__name,
  .affiliate-product--footer .affiliate-product__description {
    color: white;
  }
  
  .affiliate-product--footer .benefit-text {
    color: #d1d5db;
  }
  
  /* Styles spécifiques pour les différents contextes */
  .article-affiliate-top {
    margin: 2rem auto;
    max-width: 100%;
  }

  .article-affiliate-bottom {
    margin: 3rem auto 2rem;
    max-width: 100%;
  }

  .post-affiliate-primary {
    margin: 2.5rem auto;
  }

  .post-affiliate-secondary {
    margin: 1.5rem auto;
  }

  .collection-banner-product {
    margin: 0 auto 2rem;
  }

  .collection-grid-product {
    height: 100%;
  }

  .footer-affiliate {
    margin: 0;
  }

  .featured-main-product {
    border: 3px solid #22c55e;
  }

  .category-product-card {
    height: 100%;
    margin: 0;
  }

  /* Animation d'apparition */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .affiliate-product {
    animation: fadeInUp 0.6s ease-out;
  }

  /* Hover effects améliorés */
  .affiliate-product--inline:hover,
  .affiliate-product--featured:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .affiliate-product--grid:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
  }

  /* Styles pour le contexte collection */
  .collection-affiliate-banner {
    margin: 2rem 0;
    padding: 0 1rem;
  }

  .grid-affiliate-product {
    grid-column: span 1;
    display: flex;
    align-items: stretch;
  }

  /* Responsive amélioré */
  @media (max-width: 968px) {
    .affiliate-product--banner .affiliate-content {
      flex-direction: column;
      text-align: center;
    }

    .affiliate-product--banner .affiliate-image {
      width: 100px;
      height: 100px;
      margin: 0 auto 1rem;
    }
  }
</style>

<script>
  // Tracking des clics sur les liens d'affiliation
  document.addEventListener('DOMContentLoaded', function() {
    const affiliateLinks = document.querySelectorAll('[data-tracking^="affiliate-"]');
    
    affiliateLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        const trackingId = this.getAttribute('data-tracking');
        
        // Analytics (Google Analytics, Plausible, etc.)
        if (typeof gtag !== 'undefined') {
          gtag('event', 'affiliate_click', {
            'product_id': trackingId,
            'position': trackingId.split('-').pop()
          });
        }
        
        // Console log pour debug
        console.log('Affiliate click tracked:', trackingId);
      });
    });
  });
</script>
